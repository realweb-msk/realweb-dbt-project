# dbt проект Реалвеб

## Почему dbt?

* Контроль версии SQL моделей
* Написание тестов на схемы данных и на качество данных
* Отправка алёртов по результам тестов
* Автоматическая документация
* Оптимизация SQL за счёт переиспользования моделей
* Более гибкий аналог Scheduled Queries в BigQuery
* [и многое другое](https://docs.getdbt.com/docs/introduction)

## Документация

Красивого сайта у нас ещё нет, но вы всегда можете посмотреть на ваш проект, выполнив последовательно
```sh
dbt docs generate
dbt docs serve
``` 

## Стратегия изменений в репозитории проекта

Придерживаемся стратегии [GitHub Flow](https://docs.github.com/en/get-started/quickstart/github-flow). Для любых изменений **создаём отдельную ветку**, проверяем что всё работает (как минимум `dbt run`), отправляем pull request в master ветку, ответственный за master делает код ревью и после мерджит с master.

![image](https://user-images.githubusercontent.com/43750521/170499387-7873e660-1654-469e-a940-69b70f432189.png)

## Как начать работать с проектом?

1. [Устанавливаем Visual Studio Code](https://code.visualstudio.com/download)
2. [Устанавливаем Git](https://git-scm.com/download), вместе с ним установится терминал Git Bash.
3. Создаем вне проекта (!) папку `secrets`, куда кладем полученный в GCP (или у [@Zzdoba](https://github.com/Zzdoba)) json-ключ. Лучше всего использовать корневую директорию `C:/Users/Username/secrets/`
4. Открываем новое окно VSCode. Подключаемся к GitHub в VSCode и [скачиваем нужный репозиторий](https://code.visualstudio.com/docs/editor/versioncontrol#_cloning-a-repository). Обычно для этого достаточно перейти на страницу проводника слева (Ctrl+Shift+E), нажать "Clone Repository" и вставить ссылку (https://github.com/realweb-msk/realweb-dbt-project)
Репозиторий сохраняем в корневую папку "C:\Users\user_name\"
5. В VSCode создаем файл с переменными среды: нажимаем Ctrl+Shift+P -> Preferences: Open Workspace Settings (JSON), в открывшийся файл вставляем конфиг с переменными среды `terminal.integrated.env.[windows|linux|osx]`. Добавляем в него переменные `PATH_TO_KEYFILE` (путь к json-ключу из предыдущего шага) и `DEV_DATASET` (обычно `dbt_username`) Должно получиться примерно так:
```json
{
    "terminal.integrated.env.windows": {
        "DBT_PROFILES_DIR":".",
        "PATH_TO_KEYFILE":"C:/Users/RSultanov/secrets/dbt_runner_for_realweb.json",
        "DEV_DATASET":"dbt_rsultanov"
    }
}
```
Не забудьте нажать Ctrl+S чтоб сохранить файл. Выйдите из VSCode и откройте его заново.

6. В VSCode устанавливаем расширения `ms-python.python`, `GitHub Pull Requests and Issues`, `Git Graph` в VSCode (желательно ещё установить `innoverio.vscode-dbt-power-user` и `eamodio.gitlens`). Чтобы найти нужное расширение, воспользуйтесь Ctrl+Shift+X и строкой поиска
7. Устанавливаем Git Bash как дефолтный терминал в VSCode (можно и другой, но тогда процесс установки для вас может усложниться): Ctrl+Shift+P -> Terminal: Select Default Profile -> Git Bash.
8. Открываем терминал в VSCode (Ctrl+Shift+\`), проверяем в нём версию Python `python --version` или `python3 --version`, если его нет или версия не поддерживается ([должна быть 3.7 - 3.11](https://docs.getdbt.com/dbt-cli/install/pip)), то [устанавливаем](https://www.python.org/downloads/)
9. Переходим в скаченную папку проекта realweb-dbt-project, если вы еще не в ней (проверить - `pwd`, перейти из корневой папки - `cd realweb-dbt-project`). Запускаем установку `source ./local_install.sh` (или `source ./local_install_wsl.sh` при использовании WSL), ждем несколько минут. Если все сделано правильно, вы увидите сообщение:

![image](https://user-images.githubusercontent.com/43750521/161025724-31f26002-b351-4f1e-81d6-35a340f8c3c9.png)

<details>
<summary>Что происходит в local_install.sh?</summary>
<br>

* переходим на один уровень выше (в корневую директорию)
* устанавливаем пакет `virtualenv` и создаем виртуальное окружение `realweb-dbt-env`
* активируем его, устанавливаем в него dbt нужной версии
* возвращаемся в папку проекта realweb-dbt-project
* выполняем команды `dbt deps` и `dbt debug`
* завершаем исполнение скрипта, оставаясь в новом виртуальном окружении

При желании или при необходимости (например при выборе дефолтной консоли `command prompt` или при желании использовать другое виртуальное окружение) вы можете пройти эти шаги можно самостоятельно
</details>

10. В VSCode назначаем интерпетатор для Python в созданном виртуальном окружении (Ctrl+Shift+P -> Python: Select Interpreter -> Введите путь к интерпретатору -> Найти -> Ищем свое вирутальное окружение `realweb-dbt-env` -> В нем ищем Scripts, а там файл `python`)
11. Можете пользоваться dbt!

## Если я хочу создать свой проект?

1. [Укрепиться в решении - Вводный вебинар от OWOX про dbt](https://www.youtube.com/watch?v=eLDV_y0Chow)
2. [Пройти небольшой бесплатный курс по dbt](https://courses.getdbt.com/)
3. [Первые шаги](https://docs.getdbt.com/dbt-cli/install/overview)
4. [Запускаем dbt в продакшн на Google Cloud Platform](https://medium.com/@ivan_toriya/step-by-step-guide-to-run-dbt-in-production-with-google-cloud-platform-fb1f035f3c7b)

## Задание по dbt

NB: `username` пишите, пожалуйста, в формате "первая буква имени" + "фамилия" - так мы сможем найти вашу таблицу и ваш датасет. Примеры: `rsultanov`,`mpopkov`,`dlazuta`

Представьте: Вы пришли на работу в Риалвеб. Ваш коллега заболел, и вам предстоит закончить начатую им задачу: подготовить данные для дашборда (его вам предстоить сделать во время следующего спринта). В дашборде вам предстоит отразить количество установок приложения, показов рекламы, кликов по объявлениям и расходов по кампаниям в группировке по дате, названию кампании, группе объявлений, платформе (ios, android), рекламному кабинету. На данном этапе вам следует написать модель `username_af_installs` и материализовать ее как таблицу в датасете `dbt_production`.
К счастью, ваш коллега уже настроил работу потоков данных с помощью Garpun Feeds и написал [stg_](https://youtu.be/qOx8l_QFz9I?t=21) модели для установок и данных из рекламных кабинетов.

1. Пройдите указанным выше путем (**Как начать работать с проектом**). Если не будет хватать каких-то разрешений - выдадим.
2. Создайте свою ветку для работы - в левом нижнем углу в VSCode нажмите на кружок рядом с **main** (так вы получите свежие изменения из мастер-ветки), затем на само слово **main**, затем *Создание новой ветви из...*, затем введите имя ветви (например, своё имя), и затем *origin/main*
3. Изучите проект: посмотрите на имеющиеся в проекте модели (например `stg_af_installs`, `stg_yandex`). Найдите в папке `macros` написанные коллегой макросы - функции или фрагменты кода, которые удообно использовать в моделях. Откройте файл `schema.yml`  - заготовку для документирования моделей, куда удобно вписывать тесты. Выполните в консоли `dbt run` - так все модели в проекте попадут в ваш датасет **dbt_username**, по умолчанию в виде view.
4. Выполните в консоли `dbt test -m stg_af_installs -t prod` - после этого к таблице `stg_af_installs` (мы выбираем ее с помощью флага `-m`), находящейся в датасете `dbt_production` (это наш production-датасет, мы выбираем его с помощью `-t prod`), будут применены тесты, описанные для этой модели в файле `schema.yml` (папка `models`)
5. Теперь - к работе! В папке `models` напишите модель `username_af_installs` и материализуйте её как таблицу в датасете `dbt_production`. Модель представляет собой SQL-код, по результатам работы которого должна получиться целевая таблица: клики, показы, установки, расходы в разбивке по дате, кампании, группе объявления, платформе и источнику (рекламному кабинету). В таблице должны быть только кампании Риалвеба (`is_realweb=TRUE`), только с известным источником (`source!='other'`), только User Acquisition (`is_ret_campaign=FALSE`). Если данные о количестве установок есть в таблицах из рекламных кабинетов, берите их оттуда, а если нет - то из `stg_af_installs` (это требование заказчика, такое бывает). Обращайтесь к существующим моделям с помощью функции ref, например: 
```sql
SELECT * FROM {{ ref('stg_yandex') }}
WHERE is_realweb AND NOT is_ret_campaign
```
В процессе работы помогут команды  `dbt run -m username_af_installs` - материализация данной модели в вашем датасете (чтобы проверить код на ошибки в SQL),
`dbt run -m username_af_installs -t prod` - материализация модели в `dbt_production`.
Дополнительно можете добавить в модель [партицирование по дате](https://docs.getdbt.com/reference/resource-configs/bigquery-configs#using-table-partitioning-and-clustering).

6. Ваш заказчик требователен. В дашборде не должно быть случайно попавших туда NULL-компаний, а в столбце "платформа" не должно быть ничего кроме "ios" и "android". В файле `schema.yml` задайте для вашей модели `username_af_installs` два теста: один для названия кампании, а другой для платформы (вдохновиться примерами можно в этом же файле). Протестируйте вашу модель, выполнив `dbt test -m username_af_installs -t prod`. В норме *один из тестов должен упасть*.

7. В системе управления версиями (CTRL + SHIFT + G) напишите сообщение для фиксации (например, "Борис добавил модель boris_af_installs"), зафиксируйте ваши изменения (символ ☑️) , затем - "опубликовать ветвь", а потом  нажмите на символ справа от галочки (CREATE PULL REQUEST)[^1]. Так ваши изменения попадут на код-ревью. Если все хорошо, то мы добавим их в ветку `main` :)

[^1]: Если этой кнопки нет, может помочь установка расширения “GitHub Pull Requests and Issues” в VS Code
